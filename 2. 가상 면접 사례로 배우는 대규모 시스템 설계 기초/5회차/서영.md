# 7. 분산 시스템을 위한 유일 ID 생성기 설계

## 유일 ID 생성기

- 관계형 데이터 베이스 기본키를 쓰면 안되는 이유?
  - 서버 한대로는 요구를 감당할 수 없음. 여러 데이터베이스 서버를 쓰는 경우 지연 시간을 낮추기가 힘들 것이기 때문

## 설계 요구사항

- 유일
- 숫자
- 날짜에 따라 정렬 가능
- 64비트로 표현
- 시스템 규모 - 초당 10,000 ID 생성 가능

## 분산 시스템에서 유일성이 보장되는 ID 생성 방법

### 1. 다중 마스터 복제 (multi-master replication)

- 다음 ID 값을 구할 때 1만큼이 아닌 **K만큼** 증가 (K: 사용중인 데이터베이스 서버 수)
  - 다음 ID = (해당 서버가 생성한 이전 ID 값) + (전체 서버의 수)
- 장점
  - 규모 확장성 문제를 어느 정도 해결 가능
  - 데이터베이스 수를 늘리면 초당 생산 가능한 ID 수도 늘릴 수 있기 때문
- 단점
  - 데이터 센터에 걸쳐 **규모를 늘리기 어려움**
  - ID의 유일성은 보장되나 그 값이 시간의 흐름에 맞춰 커지도록 보장할 수는 없다 -> 요구 사항 충족 x
  - 서버를 추가하거나 삭제할 때도 잘 동작하도록 만들기 어려움

### 2. UUID (Universally Unique Identifier)

- 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 **128비트**짜리 수
  - 충돌 가능성이 매우 낮음! (중복 UUID가 생길 확률을 50%로 올리 려면 초당 10억 개의 UUID를 100년동안 계속 만들어야 함)
- 서버간 조율 없이 **독립적**으로 생성 가능
- 장점
  - UUID 만드는 것은 단순 / 서버 사이의 조율이 필요 없으므로 동기화 이슈 x
  - 각각 독립적으로 ID를 생성하므로 규모 확장이 쉽다
- 단점
  - 128비트 -> 요구사항 충족 x
  - 시간순으로 정렬할 수 없음
  - 숫자 아닌 값이 포함될 수 있다 -> 요구사항 충족 x

### 3. 티켓 서버 (ticket server)

- 플리커(온라인 사진 공유 서비스)에서 이 기술을 이용
- 티켓 서버(auto_increment 기능을 갖춘 데이터베이스 서버)를 중앙 집중형으로 하나 사용
- 장점
  - 유일성이 보장되는 숫자로 구성된 ID를 쉽게 만들 수 있음
  - 구현 쉬움 (중소 규모 애플리케이션에 적합)
- 단점
  - SPOF(Signle-Point-of-Failure)
    - 이를 해결하려면 티켓 서버가 여러개여아 하는데, 데이터 동기화 이슈가 발생할 것

### 4. 트위터 스노플레이크 (twitter snowflake) 접근법

- divider and conquer 적용
- 생성해야하는 ID 구조를 여러 section으로 분할
  - 1비트
    - 사인(sign) 비트 (나중에 음수,양수 구분)
  - 41비트
    - 타임스탬프
    - 최대값: 2^41 - 1 = 대략 69년 / 따라서 69년 이후는 ID 체계 마이그레이션 필요
  - 5비트
    - 데이터센터 ID (2^5 = 32개의 데이터 센터 지원)
  - 5비트
    - 서버 ID (데이터 센터당 32개의 서버 사용 가능)
  - 12비트
    - 일련번호
    - 2^12 = 4096개 값 가질 수 있음
    - 각 서버에서 ID를 생성할 때마다 일련 번호를 1만큼 증가, 1밀리초가 경과할 때마다 0으로 초기화

## 추가논의

- 시계 동기화
  - ID 생성 서버들이 전부 같은 시계를 사용한다고 가정함
  - 하지만 이런 가정은 하나의 서버가 여러 코어에서 실행되는 경우 유효하지 않을 수 있음
    - NTP(Network Time Protocol)로 문제 해결
- 각 section의 길이 최적화
  - 동시성이 낮고 수명이 긴 애플리케이션이라면 일련번호를 길이를 줄이고 타임스탬프 절의 길이를 늘리는 것도 ㄱㅊ
- 고가용성
