# 1장 - 사용자 수에 따른 규모 확장성

## 수직적 규모 확장 VS 수평적 규모 확장

### 수직적 규모 확장

서버에 고사양 자원을 추가하는 행위를 말하며 소위 `스케일 업(scale up)` 이라고 한다.

#### 장점

- 서버로 유입되는 트래픽이 적을 때는 수직적 확장이 좋은 선택이다.
- 가장 간단하게 성능을 높일 수 있는 방법이다.

#### 단점

- 한 대의 서버에 CPU 또는 메모리를 무한정대로 증성할 수 없기 때문에 수직적 확장은 한계가 있다.
- 한 대의 서버에 하드웨어 장비를 업그레이드 하는 것이기 때문에 자동복구(failover), 다중화(re-dundancy)에 대한 방안이 없다. 해당 서버에 장애가 발생하면 웹/앱 서비스는 중단된다.

### 수평적 규모 확장

더 많은 서버를 추가하여 성능을 개선하는 행위를 말하며 소위 `스케일 아웃(scale out)` 이라고 한다.

#### 장점

- 대규모 어플리케이션을 지원하는 서비스의 경우 수평적 확장이 유리하다. (`자동복구, 다중화를 지원할 수 있기 때문에 수직적 확장의 단점 극복`)

#### 단점

- 서버 한 대의 처리능력으로만 비교했을때 수직적 확장에 비해 성능이 떨어진다.

### 로드밸런서

웹 서버들에게 트래픽을 고르게 분산하는 역할을 한다.

#### 로드밸런서를 사용하는 경우 클라이언트 접속 처리 방식

1. 웹 브라우저 또는 모바일 앱으로 접속하려는 도메인으로 접속한다.
2. DNS 서버에서 해당 도메인의 IP를 얻는다. (`이 때 얻어온 IP는 로드밸런서의 Public IP`) --> DNS에 도메인을 등록할 때, 로드밸런서 IP를 등록해야겠지?
3. 로드밸런서에서 트래픽을 적적할 웹 서버로 분산시킨다. (`로드밸런서 <-> 웹서버간 통신에는 Private IP를 이용`)
   - 사설 IP는 같은 네트워크에 속한 서버 사이의 통신에서만 쓰일 수 있는 IP 주소이다. --> **같은 네트워크라는 기준이 무엇일까?**
   - 위의 이유로 사설 IP는 인터넷을 통해서는 접속 불가능 (`같은 네트워크에 속한 서버끼리만 통신이 가능하기 때문에 보안적 이점이 있음`)
   - 여러 대의 서버 중 특정 서버가 다운되면 트래픽은 해당 서버를 제외한 나머지 서버들에 분산되어 전송된다. (`no failover 문제 해결`)

## 캐시

값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 요청이 보다 빨리 처리될 수 있도록 하는 저장소이다.

### 캐시 계층

- 웹 서버와 데이터베이스 사이에 캐시 계층을 두어 웹 서버의 요청이 캐시 서버에 있다면 해당 데이터를 즉시 응답하고, 없다면 데이터베이스에서 읽어와 캐시 서버에 저장한 후 응답한다.
- 메모리는 디스크보다 용량이 현저하게 적다. 그렇기 때문에 캐시 서버 메모리에 모든 데이터를 다 저장할 수 없으니 어떤 데이터를 캐시 서버에 저장할 지를 정하는 전략이 매우 중요하다.

### 캐시 사용 시 유의할 점

- 일관성을 어떻게 유지할 것인가?
- 장애에는 어떻게 대처할 것인가?
  - 캐시 서버를 한 대만 두는 경우 해당 서버는 단일 장애 지점(Single Point of Failure, SPOF)가 된다.
    - SPOF는 특정 지점에서 장애가 발생할 경우 전체 시스템이 중단되는 경우 해당 지점을 단일 장애 지점이라고 한다.
    - 이 문제는 캐시 서버에만 한 정된 것이 아닌 API 서버, 데이터베이스 모두에 해당 된다. (그래서 이중화 필요)

## CDN

CDN은 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크이다. 이미지, 비디오, CSS, Javascript 파일 등을 캐시할 수 있다.

### CDN 동작 방식

1. 사용자가 이미지 URL을 이용해 이미지에 접근한다.
   - **해당 이미지 URL이 어디서 CDN 서버 URL로 변경되는거지..?**
     - 사용하려는 도메인을 CNAME Record에 등록
     - CDN 서비스 신청시 해당 도메인의 A Record 값을 CDN 업체(cloudfront, akamai) 도메인으로 변경 (도메인으로 요청시 CDN 서버로 요청가도록 해주는 작업)
2. CDN 서버의 캐시에 해당 이미지가 있는 경우 그대로 응답하고, 없는 경우 원본(Origin) 서버에 요청한다.
3. 원본 서버가 파일을 CDN 서버에 응답한다. 응답 헤더에는 해당 파일을 얼마나 캐시할 지에 대해 정의되어있는 TTL 값이 있다.
4. CDN 서버는 파일을 캐시하고 응답한다. 해당 캐시는 TTL에 명시된 시간이 끝날 때까지 캐시된다.

## 무상태(stateless) 웹 계층

만약 서버에서 사용자의 상태를 보관해야하는 경우를 가정한다.

- 사용자 A의 요청이 서버1로 유입되어 서버1에서 사용자 A에 정보를 저장하고 있다.
- 사용자 A의 이후 요청이 서버1로 전달되지 않는다면 인증에 실패할 수 있다.

이 문제를 해결하기 위해 대부분의 로드밸런서는 고정 세션(sticky session)이라는 기능을 제공한다. 하지만 이 기능은 로드밸런서에 부담을 줄 수 있고, 로드밸런서 뒷단에 서버를 추가하거나 제거하기도 까다로워진다.

이러한 추가적인 문제들을 해결하기 위해 무상태 아키텍처가 생겨났다.

무상태 아키텍처는 모든 HTTP 요청은 어떤 웹 서버로도 전달될 수 있다. 웹 서버는 상태가 필요한 경우 별도로 구성된 저장소로부터 데이터를 가져와 사용한다.
이 경우 웹 서버는 클라이언트 상태와 물리적으로 분리되어 있다. 이런 구조는 단순하고, 안정적이며, 규모 확장이 쉽다.

**클라이언트 상태를 저장하기 위한 저장소는 Redis 같은 캐시 시스템일 수도 있으며, NoSQL일 수도 있다.** --> 세션 서버도 관리해줘야 하는 부담..? 이중화 해줘야할거 같은데.. 세션 서버 죽으면 모든 클라이언트 정보 날아가는거 아닌가..

## 매새지 큐

- 오래걸리는 비동기 작업들을 큐에 넣어서 처리함으로서 기존 로직과 독립적으로 동작 가능

# 1장에서 좀 더 공부하고 싶었던 부분

## DNS (+GSLB?)

## 캐시 정책

# 2장 - 개략적인 규모 추정

어렵다.

가정

- 월간 능동 사용자(monthly active user)는 3억(300million) 명이다.
- 50%의 사용자가 트위터를 매일 사용한다.
- 평균적으로 각 사용자는 매일 2건의 트윗을 올린다.
- 미디어를 포함하는 트윗은 10% 정도다.
- 데이터는 5년간 보관된다.

추정

- QPS(Query Per Second) 추정치

  - 일간 능동 사용자(Daily Active User, DAU) = 3억 X 50% = 1.5억
  - QPS = 1.5억 X 2 트윗 / 24시간 / 3600초 = 약 3500
  - 최대 QPS(Peek QPS) = 2 X QPS = 약 7000

- 미디어 저장을 위한 저장소 요구랑
  - 평균 트윗 크기
    - tweet_id에 64바이트
    - 텍스트에 140바이트
    - 미디어에 1MB
  - 미디어 저장소 요구량: 1.5억 X 2 X 10% X 1MB = 30TB/일
  - 5년간 미디어를 보관하기 위한 저장소 요구량 = 30TB X 365 X 5 = 약 55PB

# 3장 - 시스템 설계 면접 공략법

#### 1단계 문제 이해 및 설계 범위 확정

- 구체적으로 어떤 기능을 만들어야 하는지?
- 제품 사용자 수는 얼마인지?
- 회사 규모는 얼마나 빠르게 커지는지?
- 회사가 사용하는 기술 스택은 어떤건지?

#### 개략적인 설계안 제시 및 동의 구하기

- 설계안에 대한 최초 청사진을 제시하고 의견 구하기. 면접관을 마치 팀원인 것처럼 대하라!
- 핵심 컴포넌트(API, 웹 서버, DB, 캐시, CDN, 메세지 큐 등)를 포함하는 다이어그램 그리기.
- 해당 설계안이 제약사항들을 만족하는지 개략적으로 계산해보기.

#### 상세 설계

- 설계 대상 컴포넌트 사이의 우선순위를 정하는 것 (어느 컴포넌트에서 상세하게 설게해주기를 원할지는 면접관마다 다름)
