# 채팅 시스템 설계

## 요구사항
- 1:1 채팅 및 그룹 채팅 지원
- mobile & web 모두 지원
- DAU 5000만
- 그룹 채팅 limit 100명
- 메시지 길이 limit length 100,000
- 중요 기능
  - 1:1 채팅
  - 그룹채팅
  - 사용자 접속상태 표시
  - 텍스트 메시지만 송수신 가능
  - 채팅 이력 보관
- 선택 기능
  - end to end encryption

### 개략적 설계안
- 클라이언트들로부터 메시지 수신
- 메시지 수신자 결정 및 전달
- 수신자가 접속 상태가 아닌 경우에는 접속할 때까지 해당 메시지 보관

#### 폴링
- 클라이언트가 주기적으로 서버에게 새 메시지가 있느냐고 물어보는 방식
- 답해줄 메시지가 없는 경우에는 서버 자원이 불필요하게 낭비됨

#### 롱 폴링
- 폴링은 여러가지 비 효율적일 수 있어서 나온 기법
- 클라이언트는 새 메시지가 반환되거나 타임아웃 될 때까지 연결을 유지함
- 클라이언트는 새 메시지를 받으면 기존 연결을 종료하고 서버에 새로운 요청을 보내어 모든 절차를 다시 시작함
- 단점
  - 메시지를 보내는 클라이언트와 수신하는 클라이언트가 같은 채팅 서버에 접속하게 되지 않을 수 있음
  - 서버 입장에서는 클라이언트가 연결을 해제했는지 아닌지 알 수 없음
  - 메시지를 많이 받지 않는 클라이언트도 타임아웃이 일어날 때마다 주기적으로 서버에 연결되어 비효율적임

#### 웹소켓
- 서버가 클라이언트에게 비동기 메시지를 보낼 때 가장 널리 사용하는 기술
- 웹 소켓 연결은 클라이언트가 시작하며, 한번 맺어진 연결은 항구적이며 양방향임
- 처음에는 http 연결이지만 특정 핸드셰이크 절차를 거쳐 웹소켓 연결로 업그레이드 됨
- 일반적으로 방화벽이 있는 환경에서도 잘동작함

### 무상태 서비스
- 로그인, 회원가입, 사용자 프로필 표시 등을 처리하는 전통적인 요청/응답 서비스
- 무상태 서비스가 제공하는 기능은 많은 웹사이트와 앱이 보편적으로 제공하는 기능
- lb뒤에 위치

### 상태 유지 서비스
- 유일하게 상태 유지가 필요한 서비스는 채팅 서비스
- 각 클라이언트가 채팅 서버와 독립적인 네트워크 연결을 유지해야 함
- 클라이언트는 보통 서버가 살아 있는 한 다른 서버로 연결을 변경하지 않음

### 3자 서비스 연동
- 채팅 앱에서 가장 중요한 3자 서비스는 푸시 알림임
- 새 메시지를 받았다면, 설사 앱이 실행 중이지 않더라도 알림을 받아야 함

### 규모 확장성
- 트래픽 규모가 얼마 되지 않을 때는 이 모든 기능을 서버한대로 구현할 수 있음
- 규모가 커져도 구현 자체는 가능하지만 안정적이지 않음

### 저장소
- DB를 선택하기 위해 데이터의 유형과 읽기/쓰기 연산의 패턴이 중요함
- 채팅 시스템이 다루는 데이터는 보통 2가지
  - 사용자 프로파일, 설정, 친구 목록 -> 일반적으로 RDB
  - 채팅 이력
    - 채팅 이력 데이터의 양은 엄청남
    - 이 중 가장 빈번하게 사용되는 것은 주로 최근에 주고받은 메시지
    - 사용자는 대체로 최근에 주고받은 메시지 데이터만 보게 되는 것이 사실이나, 검색 기능을 이용하거나, 특정 사용자가 언급된 메시지를 보거나, 특정 메시지로 점프하거나 하여 무작위적인 데이터 접근을 하게되는 경우도 있음
    - 채팅 앱의 경우 읽기/쓰기 비율은 대략 1:1 정도
  - 채팅 이력은 키-값 저장소 추천
    - 수평적 규모확장이 쉬움
    - 데이터 접근 지연시간이 낮음
    - RDB는 데이터 가운데 롱 테일에 해당하는 부분을 잘 처리하지 못하는 경향이 있음
    - 이미 많은 안정적인 채팅 시스템이 키-값 저장소를 채택하고 있음
      - 페이스북은 HBase, 디스코드는 카산드라 사용

## 상세 설계
### 서비스 탐색
- 서비스 탐색 기능의 주된 역할은 클라이언트에게 가장 적합한 채팅 서버를 추천하는 것
- 클라이언트의 위치, 서버의 용량 등이 있음
- 오픈소스 솔루션으로 주키퍼 등을 사용함

### 메시지 흐름
- 메시지 전송 시 해당 메시지의 id를 생성해 메시지 동기화 큐로 전송
- 큐에서 메시지를 키-값 저장소에 저장
- 수신받을 사용자의 접속 여부에 따라 채팅서버 혹은 푸시 알림 서버로 보냄
- 수신받은 사용자는 접속상태에 따라 채팅 알림 혹은 푸시 알림을 받음

### 접속 상태 표시
- 접속상태 서버를 통해 사용자의 상태를 관리
- 클라이언트와 웹소켓으로 통신하는 실시간 서비스의 일부