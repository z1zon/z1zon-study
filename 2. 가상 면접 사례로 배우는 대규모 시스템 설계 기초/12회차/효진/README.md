# 14장. 유튜브 설계

### 요구사항

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 안정성
- 모바일 앱, 웹브우저, 스마트 TV 지원

### 개략적 규모 측정

- DAU 5백만
- 한 사용자 하루에 평균 5개 비디오 시청
- 10% 사용자가 하루에 1개 비디오 업로드
- 비디오 평균 크기 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량
  - 5백만 X 10% X 300MB = 150TB
- CDN 비용
  - 아마존 클라우드프론트 사용할 경우, 트래픽 미국에서 발생한다고 가정하면 1GB당 $0.02
  - 5백만 X 5비디오 X 0.3GB X $0.02 = $150,000

### 개략적 구성

- 단말 : 컴퓨터, 모바일, 스마트 TV를 통해 유튜브 시청
- CDN : 비디오를 CDN에 저장. 재생 버튼을 누르면 CDN으로부터 스트리밍이 이루어짐
- API 서버 : 비디오 스트리밍을 제외한 모든 요청 처리. 피드 추천, 비디오 업로드 URL 생성, 메타데이터 데이터베이스와 캐시 갱신, 사용자 가입 등

### 비디오 업로드 절차

![[Pasted image 20240512133352.png]]

- **사용자** : 컴퓨터, 모바일 폰, 스마트 TV를 통해 유튜브를 시청하는 이용자
- **로드밸런서** : API 서버 각각으로 고르게 요청을 분산하는 역할
- **API 서버** : 비디오 스트리밍을 제외한 다른 모든 요청 처리
- **메타데이터 DB** : 비디오의 메타데이터 보관. 샤딩, 다중화를 적용하여 성능 및 가용성 요구사항 충족
- **메타데이터 캐시** : 성능을 높이기 위해 비디오 메타데이터와 사용자 객체는 캐시함
- **원본 저장소** : 원본 비디오를 보관할 대형 이진 파일 저장소(BLOB : 이진 데이터를 하나의 개체로 보관하는 DB 관리 시스템)
- **트랜스코딩 서버** : 비디오 인코딩이라고도 부름. 비디오의 포맷(MPEG, HLS 등)을 변환하는 절차. 단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림을 제공하기 위해 필요
- **트랜스코딩 비디오 저장소** : 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소
- **CDN** : 비디오 캐시. 사용자가 재생 버튼을 누르면 비디오 스트리밍은 CDN을 통해 이루어짐
- **트랜스코딩 완료 큐** : 비디오 트랜스코딩 완료 이벤트들을 보관할 메세지큐
- **트랜스코딩 완료 핸들러** : 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 데이터베이스를 갱신할 작업 서버들

**비디오 업로드 절차**

1. 비디오를 원본 저장소에 업로드 한다.
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩을 시작한다.
3. 트랜스코딩이 완료되면 아래 두 절차가 병렬적으로 수행된다.
   3a. 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드한다.
   3b. 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다.
   3a.1. 트랜스코딩이 끝난 비디오를 CDN에 올린다.
   3b.1. 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다.
   3b.1.a, 3b.1.b. 완료 핸들러가 메타데이터 DB와 캐시를 갱신한다.

**메타데이터 갱신**
원본 저장소에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다. 이 요청에 포함된 메타데이터에는 파일 이름, 크기, 포맷 등의 정보가 들어 있다. API 서버는 이 정보로 메타데이터 캐시와 DB를 업데이트 한다.

**비디오 스트리밍 절차**
유튜브에서 비디오 재생버튼을 누르면 스트밍은 바로 시작된다.
사용자 단말에 가장 가까운 CDN 에지 서버가 비디오 전송을 담당하여 바로 스트리밍 된다.

스트리밍 프로토콜

- MPEG-DASH (Moving Picture Experts Group, Dynamic Adaptive Streaming over HTTP)
- 애플 HLS (HTTP Live Streaming)
- 마이크로소프트 스무드 스트리밍 (Microsoft Smooth Streaming)
- 어도비 HTTP 동적 스트리밍 (Adobe HTTP Dynamic Streaming, HDS)

### 비디오 트랜스코딩

- 비디오를 녹화하면 단말은 해당 비디오를 특정 포맷으로 저장
- 이 비디오가 다른 단말에서도 순조롭게 재생되려면 다른 단말과 호환되는 비트레이트와 포맷으로 저장되어야함
- 비트레이트 : 비디오를 구성하는 비트가 얼마나 빨리 처리되아야 하는지를 나타내는 단위. 비트레이트가 높을수록 고화질 비디오

비디오 트랜스코딩이 중요한 이유

- 가공되지 않은 원본 비디오는 저장 공간을 많이 차지함
- 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원하므로 호환성 문제 해결을 위해 하나의 비디오를 여러 포맷으로 인코딩해 두는 것이 필요
- 사용자에게 끊김 없는 고화질 비디오 재생을 보장하려면 네트워크 대역폭이 충분하지 않은 사용자에게는 저화질 비디오를, 대역폭이 충분한 사용자에게는 고화질 비디오를 제공
- 모바일 단말은 네트워크 상황이 수시로 달라질 수 있으므로 비디오 화질을 자동으로 변경하거나 수동으로 변경할 수 있도록 제공

인코딩 포맷의 구성

- 컨테이너 : 비디오 파일, 오디오, 메타데이터를 담는 바구니 같은 것. 컨테이너 포맷은 .avi, .mov, .mp4 같은 파일 확장자를 보면 알 수 있음
- 코덱 : 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 압축 해제 알고리즘. H.264, VP9, HEVC 등이 있음.

유향 비순환 그래프(DAG) 모델
비디오를 트랜스코딩하는 것은 시간과 자원이 많이 소모되는 작업이므로, 작업을 단계별로 배열하여 병렬적 또는 순차적으로 실행될 수 있도록 해야함
![[Pasted image 20240512164303.png]]
비디오에 적용되는 작업

- 검사 : 좋은 품질의 비디오인지, 손상은 없는지 확인
- 인코딩 : 비디오를 다양한 해상도, 코덱, 비트레이트 조합으로 인코딩
- 썸네일 추출 : 사용자가 업로드한 이미지나 비디오에서 자동 추출된 이미지로 썸네일 추출
- 워터마크 : 비디오에 대한 식별정보를 이미지 위에 오버레이 형태로 띄워 표시

### 비디오 트랜스코딩 아키텍처

![[Pasted image 20240512164501.png]]
전처리기

1. 비디오 분할 : 비디오 스트림을 GOP(Group of Pictures, 특정 순서로 배열된 프레임 그룹) 라고 불리는 단위로 쪼갠다. 하나의 GOP는 독립적으로 재생 가능. 오래된 단말이나 브라우저는 GOP 단위의 비디오 분할을 지원하지 않아서, 전처리기가 비디오 분할을 대신해야할 수 있다.
2. DAG 생성 : 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG를 만들어 낸다.
   ![[Pasted image 20240513235816.png]]
3. 데이터 캐시 : 전처리기는 분할된 비디오의 캐시이기도 한데, 안정성을 높이기 위해 GOP와 메타데이터를 임시 저장소에 보관한다.

DAG 스케쥴러

자원 관리자

작업 실행 서버

인코딩된 비디오
