# 14장. 유튜브 설계

## BLOB

- BLOB: Binary Large Object
- BLOB 스토리지 => 이진 파일 저장소
  - 이진 데이터를 하나의 개채로 보관하는 데이터베이스 관리 시스템
- JS의 Blob : https://heropy.blog/2019/02/28/blob/
  - Blob 객체를 통해 파일을 작은 바이트 단위 쪼갤수도, 다시 합칠 수도 있음

## 비디오 업로드

- 업로드 절차에 필요한 컴포넌트들
  - `사용자`, `로드밸런서`, `API 서버`, `원본 저장소` (blob storage 시스템)
    - `트랜스코딩 서버`,`트랜스코딩 비디오 저장소`, `CDN`, `트랜스코딩 완료 큐`, `트랜스코딩 완료 핸들러`
  - `메타데이터 데이터 베이스`, `메타데이터 데이터 캐시`

비디오 업로드는 아래 두 프로세스가 병렬적으로 수행된다

1. 비디오 업로드
   1. 비디오를 `원본저장소`에 업로드
   2. `트랜스코딩 서버`가 `원본저장소`의 비디오를 가져와 **트랜스코딩** 시작
   3. 트랜스 코딩 완료 (아래 두가지 병렬 수행)
      1. 완료된 비디오를 `트랜스코딩 비디오 저장소`에 업로드
      2. `트랜스코딩 완료 이벤트`를 `트랜스 코딩 완료 큐`에 넣음
         1. 트랜스코딩이 끝난 비디오를 `CDN`에 올림
         2. `완료 핸들러`가 이벤트 데이터를 큐에서 꺼냄
         3. `완료 핸들러`가 메타데이터 데이터베이스, 메타데이터 캐시 갱신
   4. `API 서버`가 `단말`에 비디오 업로드 완료 알림 (스트리밍 준비 완료)
2. 비디오 메타데이터 갱신
   - 메타데이터 - ex) 비디오 URL, 크기, 해상도, 포맷, 사용자 정보

## 비디오 스트리밍

- 비디오는 CDN에서서 바로 스트리밍되어 제공된다.
- 널리 사용되는 스트리밍 프로토콜 (streaming protocol)
  - MPEG-DASH, 애플 - **HLS**(HTTP Live Streaming), 마이크로소프트 - MSS(Microsoft Smooth Streaming), 어도비 - HDS(HTTP Dynamic Streaming)
- **프로토콜 마다 지원하는 비디오 인코딩과 플레이어가 다르다!**

#### 참고자료 7

- https://www.dacast.com/blog/streaming-protocols/
- video streaming protocols: https://www.dacast.com/blog/video-streaming-protocol/
  - MPEG-DASH는 ABS(Adaptive bitrate streaming)을 가능하게 해준다는게 큰 장점
    - 뷰어는 항상 좋은 화질의 비디오를 전달받음
    - apple, ios 지원 x
  - HLS가 좋다
  - YouTube는 HLS이 표준 프로토콜인 HTML5 video player를 사용함
    - 사실 호환을 위해 다 사용
      - 고화질 -> HLS, DASH / low-latency streaming -> RTMP, RTMPS
      - 주로 사용되는 프로토콜 -> **RTMP**(Real-Time Messaging Protocol) (근데 HTML5 video player는 호환 x)
    - https://developers.google.com/youtube/v3/live/guides/ingestion-protocol-comparison

## 트랜스코딩 (transcoding)

- 비디오 트랜스코딩이란?

  - 비디오가 다른 단말에서도 잘 재생되려면 비디오가 다른 단말과도 호환되는 비트레이트(bitrate)와 포맷으로 저장되어야 한다.
    - 비트레이트: 비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지를 나타내는 단위
    - 고화질 비디오 -> 비트레이트가 높음
  - 비디오 트랜스코딩은 해상도, 인코딩, 비트 전송률과 같은 매개 변수를 조정하여 **비디오 파일을 한 형식에서 다른 형식으로 변환**하는 프로세스
    - 더 알아보기 👉 https://aws.amazon.com/ko/what-is/video-transcoding/
    - (AWS Elemental MediaConvert 서비스로 비디오 트랜스 코딩 가능)

- 트랜스코딩을 하면 좋은 점

  - 저장공간 줄이기 가능 (raw video는 저장공간이 너무 크기 때문)
  - 하나의 비디오를 여러 포맷을 인코딩 해둠으로써 호환성 문제 해결
  - 사용자의 네트워크 환경에 맞는 비디오를 제공 -> 끊김 없는 비디오 제공
    - 네트워크 환경에 따라 비디오 화질을 자동으로 변경

- 인코딩 포맷

  - 컨테이너 - 비디오 파일, 오디오, 메타데이터를 담는 바구니
    - ex) .avi, .mov, .mp4
  - 코덱 - coder + decoder, 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 만들어진 압축,압축 해제 알고리즘
    - ex) H.264, VP9, HEVC

- DAG 모델
  - DAG : Directed Acyclic Graph (유향 비순환 그래프)
  - 원본비디오를 비디오, 오디오, 메타데이터로 나누어 처리
  - 비디오에 적용되는 작업: 검사 (품질, 손상 확인), 비디오인코딩, 섬네일 추출, 워터마크 표시

### 비디오 트랜스코딩 아키텍처

- 주요 컴포넌트
  - `전처리기` -> `DAG 스케줄러` -> `자원 관리자` -> `작업 실행 서버` -> `인코딩된 비디오`
  - `전처리기` or `작업 실행 서버` -> `임시저장소`

1. 전처리기
   - 비디오 분할 - 비디오 스트림을 GOP(Group of Pictures), 특정 순서로 배열된 프레임 단위(보통 몇 초 정도)로 쪼갠다
   - DAG 생성 - 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG 생성
   - 데이터 캐시 - GOP와 메타데이터를 임시 저장소에 보관, 인코딩 실패 시 이 정보를 활용해 인코딩 재개
2. DAG 스케줄러 - DAG 그래프를 몇 단계로 분할해서 각 작업을 자원관리자의 작업 큐에 넣는다.
3. 자원 관리자 - 자원 배분을 효과적으로 수행, 세개의 큐와 작업 스케줄러로 구성됨
   - task queue - 실행할 작업 보관 (우선순위 큐)
   - worker queue - 작업 서버의 가용상태 정보 보관
     - running queue - 현재 실행 중인 작업, 작업 서버 정보 보관
   - 작업 스케줄러 - 최적의 작업/서버 조합을 골라 작업 수행 지시

## 시스템 최적화

- **속도, 안전성, 비용** 측면에서 시스템 최적화하기

### 속도 최적화

- 병렬화
  - 비디오를 한번에 업로드 x, 여러개의 작은 GOP로 분할하여 업로드
  - 각 절차에 **메시지 큐** 도입 -> 느슨한 시스템 결합으로 병렬성을 높임
- 업로드 센터를 사용자랑 가까운곳에 지정

### 안전성 최적화

- pre-signed된 업로드 URL을 이용
  - 허가 받은 사용자만이 비디오 업로드
- 비디오 보호
  - 디지털 저작권 관리 (DRM) 시스템 도입
  - AES 암호화 - 허락된 사용자만 암호화된 비디오 시청 가능, 암호화된 비디오는 재생시에만 복호화
  - 워터마크

### 비용 최적화

- CDN은 비쌈!
  - 인기 비디오만 CDN을 통해 재생, 다르 비디오는 서버를 통해 재생
  - 인기가 별로 없는 비디오는 인코딩 x
  - 특정 지역에서만 인기가 많은 비디오는 다른 지역이 있을 필요가 x
  - CDN 직접 구축
