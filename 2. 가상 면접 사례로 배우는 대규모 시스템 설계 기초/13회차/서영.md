# 15장. 구글 드라이브 설계

## 설계 범위

- 구글 드라이브에서 지원할 주요 기능들
  - 파일 **업로드/다운로드**
  - 파일 **동기화**
  - 파일 갱신 이력 조회
  - 파일 공유
  - 파일 편집,삭제,공유 시 알림
- 비-기능적 요구사항
  - 안정성 - 데이터 손실이 발생하면 안됨
  - 빠른 동기화 속도
  - 네트워크 대역폭 - 네트워크 대역폭을 불필요하게 많이 소모하면 안됨
  - 규모 확장성 - 아주 많은 양의 트래픽도 처리 가능해야 함
  - 높은 가용성

## 개략적 설계안

### 컴포넌트

- 웹서버 - 파일을 올리고 다운로드 하는 과정 처리
- 데이터베이스 - 사용자 데이터, 로그인 정보, 파일 정보 등의 메타데이터 보관
- 저장소 시스템 - 파일 저장을 위해 사용될 공간 (ex) 1TB)

### API

1. 파일 업로드 API - `/files/upload`
   - 인자
     - data - 업로드 할 로컬 파일
   - 단순 업로드, 이어올리기 - 두가지 업로드 타입이 있다.
     - 이어올리기 - `/files/upload?uploadType=resumable`
2. 다운로드 API - `/files/download`
   - 인자
     - path - 다운로드 할 파일 경로
3. 파일 갱신 히스토리 제공 API - `/files/list_revisions`
   - 인자
     - path - 갱신 히스토리를 가져올 파일 경로
     - limit - 히스토리 길이의 최대치

### 설계안

![](./imgs/syoung-img1.png)

1. `블록 저장소 서버`에 파일 업로드
   - 블록 저장소 서버란?
     - 클라우드 환경에서 데이터 파일을 저장하는 기술
     - **파일을 여러개의 블록으로 나눠 저장**하고, 각 블록에는 고유한 해시값이 할당된다.
     - 파일을 재구성하려면 블록을 원래 순서대로 합침!
2. 파일은 블록 단위로 나눠져 `클라우드 저장소`에 보관된다.
3. 오랫동안 사용 되지 않는 비활성화 된 데이터를 `아카이빙 저정소`에 보관
4. 로드밸런서는 요청을 API 서버에 고르게 분산
5. API 서버는 파일 업로드 이외의 모든 것을 담당하는 서버
   - 사용자 인증, 사용자 프로파일 관리, 파일 메타데이터 갱신 등
6. `메타데이터 데이터베이스`는 메타데이터 정보를 관리하고, `메타데이터 캐시`는 말그대로 메타데이터를 캐싱한다.
   - 메타데이터 - 사용자, 파일, 블록, 버전 등의 정보
7. `알림 서비스` 는 파일이 추가, 편집, 삭제되었을 때 이를 클라이언트에게 알려서 파일의 최신 상태를 확인할 수 있도록 한다.
8. 오프라인 사용자 백업 큐 - 클라이언트가 접속중이 아니라서 파일 최신 상태를 확인할 수 없더라도 이 정보를 큐에 두어 나중에 클라이언트가 접속했을 때 동기화 되도록 한다.

## 상세 설계

### 블록 저장소 서버

블록저장소 서버는 파일을 업로드 하기 전에 다음 과정들을 거친다.

1. 클라이언트가 보낸 파일을 블록 단위로 나눔
2. 각 블록에 압축 알고리즘 적용
3. 암호화

하지만, 정기적으로 갱신되는 큰 파일들을 업데이트가 될 때마다 전체를 서버로 보내면 네트워크 대역폭을 많이 잡아먹게 된다.
이를 최적화 하기 위해 크게 두가지 방법을 사용한다.

- 델타 동기화 (delta sync) : 파일이 수정되면 전체 파일을 수정하는게 아니라 **수정이 일어난 블록만** 동기화
- 압축 (compression): 블록 단위로 압축해두어 데이터 크기를 줄일 수 있다.

### 높은 일관성 요구사항

- 같은 파일이 단말이나 사용자에 따라 다르게 보이면 안됨!
- 강한 일관성을 달성하려면
  - 캐시에 보관된 사본과 데이터베이스에 있는 원본이 일치해야 한다.
  - 데이터베이스에 보관된 원본에 변경이 발생하면 캐시에 있는 사본을 무효화 한다.
- 관계형 데이터 베이스는 ACID를 보장하므로 강한 일관성을 보장하기 쉽다.

### 메타데이터 데이터베이스

- 스키마 설계
  - user - 사용자 정보
  - device - 단말 정보 보관
  - namespace - 사용자의 루트 디렉터리 정보 보관
  - file - 파일의 최신정보 보관
  - file_version - 파일의 갱신 이력 보관, 갱신 이력 훼손을 막기 위해 읽기 전용
  - block - 파일 블록에 대한 정보 보관, 블록을 조합해 특정 버전의 파일을 복원해 낼 수 있다.
    - 컬럼 : block_id, file_version_id, block_order

### 업로드 절차

업로드 시에는 두 가지 요청이 병렬로 전송된다

- 파일 메타데이터 추가
  1.  클라이언트(user1)가 새 파일의 메타데이터를 추가하기 위한 요청 전송
  2.  새 파일의 메타데이터를 데이터베이스에 저장하고 업로드 상태를 `pending`으로 변경
  3.  새 파일이 추가됨을 알림 서비스에 통지
- 파일을 클라우드 저장소에 업로드
  1.  클라이언트(user1)가 파일을 블록 저장소에 업로드
  2.  블록 저장소가 파일을 블록 단위로 쪼갠 뒤 압축하고 암호화하여 클라우드 저장소에 전송
  3.  업로드가 끝나면 클라우드 저장소는 완료 콜백 호출, 이 콜백 호출은 API 서버로 전송됨
  4.  메타 데이터 DB에 기록된 해당 파일 상태를 `uploaded`로 변경
  5.  알림 서비스에 파일 업로드 끝남 통지
  6.  알림서비스는 관련된 클라이언트(user2)에게 파일 업로드 끝남을 알림

### 저장소 공간 절약

저장소 공간을 절약하기 위해 보통 3가지 방법을 사용한다.

- 중복 제거 - 해시값을 통해 두 블록이 같은지 판단
- 지능적 백업 전략 도입
  - 한도 설정 - 보관해야 하는 파일 버전 개수에 상한을 둔다 (상한을 도달하면 제일 오래된 버전은 버림)
  - 중요한 버전만 보관 - 자주 변경되는 파일의 경우 중요한 버전만 골라 남긴다.
- 자주 쓰이지 않는 데이터 아카이빙 저장소로 옮김
