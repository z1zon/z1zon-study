# 13장. 검색어 자동완성 시스템

## 요구사항

- 빠른 응답 속도: 사용자가 검색어를 입력할 때마다 자동완성 검색어도 표시되어야 한다.
- 연관성: 사용자가 입력한 단어와 연관되어야 한다.
- 정렬: 인기도 등의 순위 모델에 의해 정렬되어 있어야 한다.
- 규모 확정성: 시스템은 많은 트랙픽을 감당할 수 있도록 확장 가능해야 한다.
- 고가용성: 시스템의 문제가 생겨도 가용할 수 있어야 한다.

요구사항의 개략적 추정

- DAU는 천 만명으로 가정
- 평균적으로 한 사용자는 매일 10건의 검색을 수행한다고 가정
- 질의할 때마다 평균적으로 20바이트의 데이터를 입력한다고 가정
- 평균적으로 1회 검색당 20건의 요청이 백엔드로 전달된다고 가정
- 대략 초당 24,000건의 QPS가 발생할 것이고 최대 QPS는 48,000건이 될 것이다.
  - 천만 사용자 _ 10질의 / 일 _ 20자 / 24시간 / 3600초
- 질의 가운데 20%는 신규 검색어라고 가정하면
  - 천만 사용자 _ 10질의 / 일 _ 20자 \* 20%로 매일 0.4GB의 신규 데이터가 시스템에 추가된다

### 트라이 자료구조

트라이는 문자열들을 간략하게 저장할 수 있는 자료구조다. 문자열을 꺼내는 연산에 최적화되어 있다.

트라이 자료구조의 핵심 아이디어는 다음과 같다.

- 트라이는 트리형태의 자료구조
- 루트 노드는 빈 문자열
- 각 노드는 문자 하나를 저장하며, 26개의 자식노드를 가질 수 있다.
- 각 트리 노드는 하나의 단어 또는 prefix string을 나타낸다.

이용 빈도에 따라 정렬된 값을 반환하기 위해서 노드에 빈도 정보를 같이 저장한다.

트라이 자료구조와 노드의 빈도를 입힌 예시
해당 트라이로 "be"을 입력했다고 가정하고 시간복잡도와 알고리즘을 알아보자.

- p: prefix의 길이
- n: 트라이 노드 개수
- c: 주어진 노드의 자식 개수

가장 많이 사용된 질의어 k 개는 다음과 같이 찾을 수 있다. (k = 3이라고 가정)

- 해당 접두어를 표현하는 노드를 찾는다. O(p)
  - b -> be
- 해당 노드부터 시작하는 하위 트리를 탐색하여 모든 유효 노드를 찾는다. O(n)
  - 유효 노드란? 사용자가 검색한 문자열을 구성하는 노드
  - 그림 13.7의 경우 [bee: 20], [beer: 10], [best: 35], [bet: 29]가 유효한 노드가 될 것이다.
- 상위 k개 검색어를 정렬한다. O(clogc)
  - [best:35], [bet:29], [bee: 20]

따라서 최종 시간 복잡도는 O(p) + O(n) + O(clogc)가 된다.

해당 알고리즘을 최적화하기 위해서 다음 두 가지 방법이 있을 것이다.

- 접두어 최대 길이 제한
  - p값을 작은 정숫값으로 제한한다면 O(1)이 될 것이다.
- 노드에 인기 검색어 캐시
  - 각 노드에 인기 질의어를 캐시 하면 공간 복잡도는 증가하겠지만 시간 복잡도를 엄청나게 낮출 수 있다.

### 데이터 수집 서비스

### 질의 서비스
